<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="utf-8" />
		<title>Web Controlled Servos</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!--[if lt IE 9]>
		<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
		<!-- CSS only -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

		<!-- JS, Popper.js, and jQuery -->
		<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
		
		<script src="jogDial.min.js" type="text/javascript"></script>
		<style>
			.dial {
				display: block;
				position: relative;
				height: 320px;
			  }
			  
			  .dial.hidden {
				display: none;
			  }
			  
			  #dial0, #dial1, #dial2, #dial3  {
				position: relative;
				width: 260px;
				height: 260px;
				margin: 20px auto;
				background: url('base_one_bg.png');
				background-repeat: none;
			  }
			  div[id$="_knob"] {
				background-color: #999;
				background: url('base_one_knob.png');
				/* background-repeat: none; */
			  }
			   
			  div[id$="_meter"] {
				width: 200px;
				height: 10px;
				margin: 20px auto 30px;
				background: #999;
				overflow: hidden;
				-webkit-border-radius: 5px;
				-moz-border-radius: 5px;
				-ms-border-radius: 5px;
				-o-border-radius: 5px;
				border-radius: 5px;
			  }
			  div[id$="_meter"] div {
				position: relative;
				width: 0;
				height: 100%;
				background: #80e93a;
			  }
			  
			  header {
				  padding-bottom: 40px;
			  }		  
			  div.actions {
				  padding-top: 240px;
				  padding-bottom: 40px;
			  }		  
		</style>	
	</head>

<body>
	<header>
		<div class="navbar navbar-dark bg-dark shadow-sm">
			<div class="container d-flex justify-content-between">
				<a href="#" class="navbar-brand d-flex align-items-center">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true" class="mr-2" viewBox="0 0 24 24" focusable="false"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
				<strong>WebServos</strong>
				</a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
				</button>
			</div>
		</div>
	</header>
	<div class="container">

		<div class="dials row" id="dials">
			<div class="col-md-2">
				<div class="btn-group-lg btn-group-vertical btn-group-toggle btn-block actions" data-toggle="buttons">
						<label class="btn btn-lg btn-outline-secondary active">
							<input type="radio" name="follow" id="follow" autocomplete="off" onclick="handleMode(this);" checked>Follow
						</label>
						<label class="btn btn-lg btn-outline-secondary">
							<input type="radio" name="play" id="play" autocomplete="off" onclick="handleMode(this);">Play
						</label>
						<label class="btn btn-lg btn-outline-secondary">
							<input type="radio" name="startRecord" id="start" autocomplete="off" onclick="handleMode(this);">Record
						</label>
						<label class="btn btn-lg btn-outline-secondary">
							<input type="radio" name="stopRecord" id="stop" autocomplete="off" onclick="handleMode(this);">Stop Recording
						</label>
				</div>
			</div>

			<div class="col-md-10">
				<div class="row">
					<div class="well well-lg col-md-6">
						<h4 class="text-center">Servo 0 <br/><small class="text-muted" id="title0"></small></h4>
						<div class="dial" data-servo="0" data-degrees="0" id="dial0"></div>
						<div id="dial0_meter"><div></div></div>				
					</div>
					<div class="well well-lg col-md-6">
						<h4 class="text-center">Servo 1<br/><small class="text-muted" id="title1"></small></h4>
						<div class="dial" data-servo="1" data-degrees="0" id="dial1"></div>					
						<div id="dial1_meter"><div></div></div>
					</div>
					<div class="well well-lg col-md-6">
						<h4 class="text-center">Servo 2<br/><small class="text-muted" id="title2"></small></h4>
						<div class="dial" data-servo="2" data-degrees="0" id="dial2"></div>
						<div id="dial2_meter"><div></div></div>
					</div>
					<div class="well well-lg col-md-6">
						<h4 class="text-center">Servo 3<br/><small class="text-muted" id="title3"></small></h4>
						<div class="dial" data-servo="3" data-degrees="0" id="dial3"></div>
						<div class="meter" id="dial3_meter"><div></div></div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script language="javascript" type="text/javascript">
		var url = "ws://"+ window.location.hostname +":1337/";
		var online = false, 
		    recording = false;
		var vdial0, vdial1, vdial2, vdial3;
		var servos = [vdial0, vdial1, vdial2, vdial3];			
		

		// This is called when the page finishes loading
		function init() {
			var opts = { 
				debug: false, 
				knobSize:'70px',     // 30%
				wheelSize:'200px',   // 100%
				minDegree: 0, 
				maxDegree: 270, 
				touchMode: "knob"
			};

		    // Assign page elements to variables
			vdial0 = JogDial(document.getElementById("dial0"), opts)
				.on("mousemove", function(event){ 
						$('#dial0_meter div').css('width', Math.round((event.target.rotation/opts.maxDegree)*100) + '%' );
						$('#title0').html( Math.round(event.target.degree) + '%' );
						doSend('{"action":"follow","servo":0,"degree":' + Math.floor( event.target.degree ) +'}');
					});
			vdial1 = JogDial(document.getElementById("dial1"), opts)
				.on("mousemove", function(event){ 
						$('#dial1_meter div').css('width', Math.round((event.target.rotation/opts.maxDegree)*100) + '%' );
						$('#title1').html( Math.round(event.target.degree) + '%' );
						doSend('{"action":"follow","servo":1,"degree":' + Math.floor( event.target.degree ) +'}');
					});
			vdial2 = JogDial(document.getElementById("dial2"), opts)
				.on("mousemove", function(event){ 
						$('#dial2_meter div').css('width', Math.round((event.target.rotation/opts.maxDegree)*100) + '%' );
						$('#title2').html( Math.round(event.target.degree) + '%' );
						doSend('{"action":"follow","servo":2,"degree":' + Math.floor( event.target.degree ) +'}');
					});
			vdial3 = JogDial(document.getElementById("dial3"), opts)
				.on("mouseup", function(event){ 
					$('#dial3_meter div').css('width', Math.round((event.target.rotation/opts.maxDegree)*100) + '%' );
					$('#title3').html( Math.round(event.target.degree) + '%' );
					doSend('{"action":"follow","servo":3,"degree":' + Math.floor( event.target.degree ) +'}');
				});

			$('[id*="_wheel"]').css('opacity',0);

	    // Connect to WebSocket server
	    wsConnect(url);
		}

		function handleMode(id) {
			// '{"action":"follow|play|startRecord|stopRecord"}'
			doSend('{"action":"' + id.name + '"}')
		}

		// Call this to connect to the WebSocket server
		function wsConnect(url) {
		    // Connect to WebSocket server
		    websocket = new WebSocket(url);

		    // Assign callbacks
		    websocket.onopen    = function(evt) { onOpen(evt) };
		    websocket.onclose   = function(evt) { onClose(evt) };
		    websocket.onmessage = function(evt) { onMessage(evt) };
		    websocket.onerror   = function(evt) { onError(evt) };
		}

		// Called when a WebSocket connection is established with the server
		function onOpen(evt) {
		    // Log connection state
		    console.log("Connected");

		    // Enable button
		    online = true;

				// Get the current state of the LED			
		    doSend('{"action":"currentState"}');
		}

		// Called when the WebSocket connection is closed
		function onClose(evt) {
		    // Log disconnection state
		    console.log("Disconnected");

		    // Disable button
		    online = false;

		    // Try to reconnect after a few seconds
		    setTimeout(function() { wsConnect(url) }, 2000);
		}

		function updateDialPosition(package) {
			if(package.servo == 0) {
				vdial0.angle(package.degree); 
				$('#title0').html( package.degree + '%' );

			} else if (package.servo == 1) {
				vdial1.angle(package.degree); 
				$('#title1').html( package.degree + '%' );

			} else if (package.servo == 2) {
				vdial2.angle(package.degree); 
				$('#title2').html( package.degree + '%' );

			} else if (package.servo == 3) {
				vdial3.angle(package.degree); 
				$('#title3').html( package.degree + '%' );

			} else {
				console.log("Unknown Servo!: " + evt.data);
			}
		}

		// Called when a message is received from the server
		function onMessage(evt) {
			var package =  JSON.parse(evt.data);

		    // Update circle graphic with LED state
		    switch(package.action) {
				case "state": // '{"action":"state","servo":2,"degree":135}'
					updateDialPosition(package);
					console.log("State=" + evt.data );
					break;
					
				case "record": // '{"action":"record","servo":2,"degree":135}'
				  if (!recording) {
						break;
					}
					updateDialPosition(package);
					console.log("Recording=" + evt.data );
					break;
				
				case "follow":
					recording = false;
					console.log("Follow=" + evt.data );
					break;

				case "play":
					recording = false;
					console.log("Play=" + evt.data );
					break;

				case "startRecord":
					recording = true;
					console.log("Start Recording=" + evt.data );
					break;

				case "stopRecord":
					recording = false;
					console.log("Stop Recording=" + evt.data );
					break;
					
		    default:
		            break;
		    }
		}

		// Called when a WebSocket error occurs
		function onError(evt) {
		    console.log("ERROR: " + evt.data);
		}

		// Sends a message to the server (and prints it to the console)
		function doSend(message) {
			if (online) {
				console.log("Online, Sending: " + message);
				websocket.send(message);
			} else {
				console.log("Offline, Not sending: " + message);
			}
		}

		// Call the init function as soon as the page loads
		window.addEventListener("load", init, false);

	</script>
</body>

</html>
